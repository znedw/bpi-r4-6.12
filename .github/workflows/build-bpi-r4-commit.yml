name: Build OpenWrt (BPI-R4, 6.12, commit)

on:
  workflow_dispatch:
    inputs:
      refToBuild:
        description: 'Commit SHA / branch / tag pro build'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.refToBuild }}

      - name: Free disk space on runner
        run: |
          sudo rm -rf \
            "$AGENT_TOOLSDIRECTORY" \
            /opt/ghc \
            /opt/google/chrome \
            /opt/microsoft/msedge \
            /opt/microsoft/powershell \
            /opt/pipx \
            /usr/lib/mono \
            /usr/local/julia* \
            /usr/local/lib/android \
            /usr/local/lib/node_modules \
            /usr/local/share/chromium \
            /usr/local/share/powershell \
            /usr/share/dotnet \
            /usr/share/swift
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext libncurses-dev libssl-dev python3-distutils python3-setuptools \
            rsync swig unzip zlib1g-dev file wget libelf-dev ccache git

      - name: Show disk space
        run: df -h

      - name: Run builder script
        run: |
          chmod +x ./bpi-r4-openwrt-builder.sh
          ./bpi-r4-openwrt-builder.sh

      - name: List built images
        if: always()
        run: |
          ls -R openwrt/bin/targets || true

      - name: Delete old artifacts with same name (manual)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const artifacts = await github.rest.actions.listArtifactsForRepo({ owner, repo, per_page: 100 });
            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name === 'openwrt-bpi-r4-6.12-images-manual') {
                await github.rest.actions.deleteArtifact({
                  owner,
                  repo,
                  artifact_id: artifact.id,
                });
              }
            }

      - name: Cleanup build output
        if: success()
        run: |
          cd openwrt/bin/targets/mediatek/filogic

          rm -rf kernel-debug.tar.zst
          rm -rf packages

          for f in mt7988-ram-*.bin; do
            [ "$f" = "mt7988-ram-ddr4-bl2.bin" ] || rm -f "$f"
          done

      - name: Create ZIP with all images
        if: success()
        run: |
          cd openwrt/bin/targets/mediatek/filogic
          zip -r openwrt-bpi-r4-6.12-images-manual.zip .

      - name: Set short SHA and tag
        id: vars
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "tag_name=bpi-r4-commit-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Upload firmware artifacts (manual)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-bpi-r4-6.12-images-manual
          path: openwrt/bin/targets/mediatek/filogic/

      - name: Create or update GitHub Release (manual)
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          name: BPI-R4 build (commit ${{ steps.vars.outputs.short_sha }})
          body: |
            Built from ref: ${{ inputs.refToBuild }}
            Effective commit: ${{ steps.vars.outputs.short_sha }}
          draft: false
          prerelease: false
          files: |
            openwrt/bin/targets/mediatek/filogic/openwrt-bpi-r4-6.12-images-manual.zip
            openwrt/bin/targets/mediatek/filogic/config.buildinfo
            openwrt/bin/targets/mediatek/filogic/feeds.buildinfo
            openwrt/bin/targets/mediatek/filogic/mt7988-ram-ddr4-bl2.bin
            openwrt/bin/targets/mediatek/filogic/openwrt-mediatek-filogic-bananapi_bpi-r4-emmc-bl31-uboot.fip
            openwrt/bin/targets/mediatek/filogic/openwrt-mediatek-filogic-bananapi_bpi-r4-emmc-gpt.bin
            openwrt/bin/targets/mediatek/filogic/openwrt-mediatek-filogic-bananapi_bpi-r4-emmc-preloader.bin
            openwrt/bin/targets/mediatek/filogic/openwrt-mediatek-filogic-bananapi_bpi-r4-initramfs-kernel.bin
            openwrt/bin/targets/mediatek/filogic/openwrt-mediatek-filogic-bananapi_bpi-r4-sdcard.img.gz
            openwrt/bin/targets/mediatek/filogic/openwrt-mediatek-filogic-bananapi_bpi-r4-snand-bl31-uboot.fip
            openwrt/bin/targets/mediatek/filogic/openwrt-mediatek-filogic-bananapi_bpi-r4-snand-preloader.bin
            openwrt/bin/targets/mediatek/filogic/openwrt-mediatek-filogic-bananapi_bpi-r4-squashfs-sysupgrade.itb
            openwrt/bin/targets/mediatek/filogic/sha256sums
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete older manual releases with same tag prefix
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            const releases = await github.rest.repos.listReleases({
              owner,
              repo,
              per_page: 100
            });

            // Najdeme všechny releasy, jejichž tag_name zaèíná na "bpi-r4-commit-"
            const manualReleases = releases.data.filter(
              rel => rel.tag_name && rel.tag_name.startsWith('bpi-r4-commit-')
            );

            // Seøadíme podle creation date (nejnovìjší první)
            manualReleases.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            // Necháme si jen první (nejnovìjší), zbytek smažeme
            const toDelete = manualReleases.slice(1);

            for (const rel of toDelete) {
              try {
                // smazat release
                await github.rest.repos.deleteRelease({
                  owner,
                  repo,
                  release_id: rel.id
                });

                // smazat tag
                if (rel.tag_name) {
                  await github.rest.git.deleteRef({
                    owner,
                    repo,
                    ref: `tags/${rel.tag_name}`,
                  });
                }
              } catch (e) {
                console.log(`Failed to delete release/tag ${rel.tag_name}: ${e.message}`);
              }
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
